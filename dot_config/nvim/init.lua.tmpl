-- #############################################################################
-- dpp.vim setup
-- #############################################################################
local home = vim.fn.expand("$HOME")
local dpp_base = home .. "/.cache/dpp"

-- Required by some plugins before loading state
vim.opt.termguicolors = true

-- Set $BASE_DIR environment variable for dpp-ext-toml to expand paths
vim.env.BASE_DIR = home .. "/.config/nvim"

local dpp_src = dpp_base .. "/repos/github.com/Shougo/dpp.vim"
-- プラグイン内のLuaモジュールを読み込むため、先にruntimepathに追加する必要があります。
vim.opt.runtimepath:prepend(dpp_src) 
local dpp = require("dpp")

local dpp_config = home .. "/.config/nvim/dpp.ts"

local denops_src = dpp_base .. "/repos/github.com/vim-denops/denops.vim"

local ext_toml = dpp_base .. "/repos/github.com/Shougo/dpp-ext-toml"
local ext_lazy = dpp_base .. "/repos/github.com/Shougo/dpp-ext-lazy"
local ext_installer = dpp_base .. "/repos/github.com/Shougo/dpp-ext-installer"
local ext_git = dpp_base .. "/repos/github.com/Shougo/dpp-protocol-git"

vim.opt.runtimepath:append(ext_toml)
vim.opt.runtimepath:append(ext_git)
vim.opt.runtimepath:append(ext_lazy)
vim.opt.runtimepath:append(ext_installer)

-- denops shared serverの設定
-- vim.g.denops_server_addr = "127.0.0.1:34141"

-- denopsのデバッグフラグ
-- denopsプラグインの開発をしない場合は0(デフォルト)にしてください
-- vim.g["denops#debug"] = 1

if dpp.load_state(dpp_base) then
  vim.opt.runtimepath:prepend(denops_src)

  vim.api.nvim_create_autocmd("User", {
	  pattern = "DenopsReady",
  	callback = function ()
		vim.notify("vim load_state is failed")
  		dpp.make_state(dpp_base, dpp_config)
  	end
  })
end

-- これはなくても大丈夫です。
vim.api.nvim_create_autocmd("User", {
	pattern = "Dpp:makeStatePost",
	callback = function ()
		vim.notify("dpp make_state() is done")
	end
})
-- #############################################################################
-- load other settings
-- #############################################################################
require('keymap')
require('lsp')
require('opt')

-- ColorScheme setup (with fallback for async plugin loading)
vim.api.nvim_create_autocmd(
    "ColorScheme",
    { pattern = "*", command = "hi ColorColumn gui=reverse cterm=italic" }
)

local ok = pcall(vim.cmd, "colorscheme iceberg")
if not ok then
    vim.api.nvim_create_autocmd("VimEnter", {
        once = true,
        callback = function()
            pcall(vim.cmd, "colorscheme iceberg")
        end,
    })
end

-- config for nvim-lastplace
local lastplace_ok, lastplace = pcall(require, 'nvim-lastplace')
if lastplace_ok then
    lastplace.setup {
        lastplace_ignore_buftype = { "quickfix", "nofile", "help" },
        lastplace_ignore_filetype = { "gitcommit", "gitrebase", "svn", "hgcommit" },
        lastplace_open_folds = true
    }
else
    vim.api.nvim_create_autocmd("VimEnter", {
        once = true,
        callback = function()
            local ok_later, lastplace_later = pcall(require, 'nvim-lastplace')
            if ok_later then
                lastplace_later.setup {
                    lastplace_ignore_buftype = { "quickfix", "nofile", "help" },
                    lastplace_ignore_filetype = { "gitcommit", "gitrebase", "svn", "hgcommit" },
                    lastplace_open_folds = true
                }
            end
        end,
    })
end

{{ if (eq .chezmoi.username "ryosuke.nakata") }}
vim.cmd('autocmd BufNewFile,BufRead *.slim set filetype=slim')
{{ end }}
